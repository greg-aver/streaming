# Event-Driven Architecture –¥–ª—è Speech-to-Text Service

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç **Event-Driven Architecture –≤ —Ä–∞–º–∫–∞—Ö –º–æ–Ω–æ–ª–∏—Ç–∞** —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é **Event Bus**, –∞ –ù–ï –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É. –≠—Ç–æ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —Ä–µ—á–µ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### **–ï–¥–∏–Ω—ã–π –º–æ–Ω–æ–ª–∏—Ç `speech-service` —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:**

#### **1. Event Bus - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π (`AsyncEventBus`)**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å–æ–±—ã—Ç–∏–π
- Structured logging –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

#### **2. Workers (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π):**
- ‚úÖ **VAD Worker** - —Å–ª—É—à–∞–µ—Ç `audio_chunk_received`, –ø—É–±–ª–∏–∫—É–µ—Ç `vad_completed` + `speech_detected`
- ‚úÖ **ASR Worker** - —Å–ª—É—à–∞–µ—Ç `speech_detected`, –ø—É–±–ª–∏–∫—É–µ—Ç `asr_completed`  
- ‚è≥ **Diarization Worker** - —Å–ª—É—à–∞–µ—Ç `speech_detected`, –ø—É–±–ª–∏–∫—É–µ—Ç `diarization_completed`

#### **3. Services (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞):**
- ‚úÖ **VAD Service** (Silero + Mock –≤–µ—Ä—Å–∏–∏)
- ‚úÖ **ASR Service** (Faster-Whisper + Mock –≤–µ—Ä—Å–∏–∏) - –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- ‚è≥ **Diarization Service** (pyannote + Mock –≤–µ—Ä—Å–∏–∏)

#### **4. Aggregator** (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è):
- –°–ª—É—à–∞–µ—Ç: `vad_completed`, `asr_completed`, `diarization_completed`
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ü—É–±–ª–∏–∫—É–µ—Ç: `chunk_complete` —Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

#### **5. WebSocket Handler** (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è):
- –ü–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç `audio_chunk_received`
- –°–ª—É—à–∞–µ—Ç `chunk_complete` ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∏–µ–Ω—Ç—É

## üîÑ –ü–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–π

```
Client (WebSocket) 
    ‚Üì audio chunk
WebSocket Handler ‚Üí üì¢ audio_chunk_received
    ‚Üì
VAD Worker ‚Üí üì¢ vad_completed + speech_detected (–µ—Å–ª–∏ —Ä–µ—á—å)
    ‚Üì
ASR Worker ‚Üí üì¢ asr_completed 
    ‚Üì
Diarization Worker ‚Üí üì¢ diarization_completed
    ‚Üì
Aggregator ‚Üí üì¢ chunk_complete
    ‚Üì
WebSocket Handler ‚Üí Client (—Ä–µ–∑—É–ª—å—Ç–∞—Ç)
```

## üìä –°–æ–±—ã—Ç–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ

| –°–æ–±—ã—Ç–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –°–ª—É—à–∞—Ç–µ–ª–∏ | –î–∞–Ω–Ω—ã–µ |
|---------|----------|-----------|--------|
| `audio_chunk_received` | WebSocket Handler | VAD Worker | session_id, chunk_id, audio_data |
| `vad_completed` | VAD Worker | Aggregator | —Ä–µ–∑—É–ª—å—Ç–∞—Ç VAD |
| `speech_detected` | VAD Worker | ASR, Diarization Workers | session_id, chunk_id, audio_data |
| `asr_completed` | ASR Worker | Aggregator | —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ |
| `diarization_completed` | Diarization Worker | Aggregator | —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏ |
| `chunk_complete` | Aggregator | WebSocket Handler | —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Event-Driven Monolith

1. **–°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å** - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–±—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ workers
3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π worker —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ —á–µ—Ä–µ–∑ mock —Å–æ–±—ã—Ç–∏—è
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –Ω–µ—Ç network overhead –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏
5. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–µ–ø–ª–æ—è** - –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å, –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
6. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
7. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - –∏–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
8. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

## üîß –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### **‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- Event Bus —Å–∏—Å—Ç–µ–º–∞ —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏ (`AsyncEventBus`)
- VAD Worker —Å —Å–æ–±—ã—Ç–∏–π–Ω–æ–π –ª–æ–≥–∏–∫–æ–π  
- ASR Worker —Å —Å–æ–±—ã—Ç–∏–π–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
- Mock —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (VAD, ASR)
- DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- Structured logging —á–µ—Ä–µ–∑ structlog
- Clean Architecture —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏

### **üîÑ –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (–ò—Ç–µ—Ä–∞—Ü–∏—è 2):**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Mock ASR Service
- –°–æ–∑–¥–∞–Ω–∏–µ Mock Diarization Service
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### **‚è≥ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:**
- Diarization Worker
- Result Aggregator 
- WebSocket Handler (FastAPI)
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ main.py
- Containerization (Docker)

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### Event Bus
```python
# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
event_bus = AsyncEventBus()
await event_bus.publish(event)
await event_bus.subscribe("event_name", handler)
```

### Workers
```python
# Worker –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
class VADWorker(IWorker, EventSubscriberMixin, EventPublisherMixin):
    async def start(self):
        await self.subscribe_to_event("audio_chunk_received", self._handle_audio_chunk)
```

### Services
```python
# Service —Ä–µ–∞–ª–∏–∑—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
class SileroVADService(IVADService):
    async def detect_speech(self, audio_data: bytes) -> Dict[str, Any]
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏

### –ò—Ç–µ—Ä–∞—Ü–∏—è 3: Workers —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. VAD worker —Å mock —Å–µ—Ä–≤–∏—Å–æ–º
2. ASR worker —Å mock —Å–µ—Ä–≤–∏—Å–æ–º  
3. Diarization worker —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ò—Ç–µ—Ä–∞—Ü–∏—è 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
1. Event flow —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
2. End-to-end pipeline —Ç–µ—Å—Ç
3. –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –ò—Ç–µ—Ä–∞—Ü–∏—è 5: WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
1. FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å WebSocket endpoint
2. Result Aggregator —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
3. –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: Client ‚Üí WebSocket ‚Üí Event Bus ‚Üí Workers ‚Üí Response

## üèóÔ∏è –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- **Event-Driven Architecture** - –æ—Å–Ω–æ–≤–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
- **Clean Architecture** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏ (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, —Å–µ—Ä–≤–∏—Å—ã, workers)
- **Dependency Injection** - —á–µ—Ä–µ–∑ dependency-injector
- **Publisher-Subscriber** - —á–µ—Ä–µ–∑ Event Bus
- **Command Query Separation** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **Domain Events** - —Å–æ–±—ã—Ç–∏—è –∫–∞–∫ first-class citizens

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

Event Bus –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏:
```python
stats = await event_bus.get_stats()
# {
#   "total_event_types": 6,
#   "total_subscribers": 8, 
#   "event_history_size": 150,
#   "event_counts": {"vad_completed": 50, "asr_completed": 45},
#   "subscriber_breakdown": {"vad_completed": 2, "speech_detected": 3}
# }
```

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**: `docs/CURRENT_STATUS.md` - –ì–î–ï –ú–´, –ß–¢–û –î–ï–õ–ê–ï–ú, –ö–£–î–ê –ò–î–ï–ú
- **–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: `docs/DEVELOPMENT_METHODOLOGY.md` - –ö–ê–ö —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥)
- **–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å**: `TESTING_LOG.md` - –ª–æ–≥ –∏—Ç–µ—Ä–∞—Ü–∏–π –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ü–ª–∞–Ω—ã**: `TODO.md` - –∑–∞–¥–∞—á–∏ –∏ roadmap

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-08-02  
**–í–µ—Ä—Å–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**: 1.0  
**–°—Ç–∞—Ç—É—Å**: Event-Driven Architecture –≤ –º–æ–Ω–æ–ª–∏—Ç–µ - –ê–ö–¢–ò–í–ù–ê–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ê  
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è**: –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å –ø–æ–ª–Ω—ã–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏  
**–Ø–∑—ã–∫ –ø—Ä–æ–µ–∫—Ç–∞**: –†—É—Å—Å–∫–∏–π (–≤—Å–µ –º–æ–¥–µ–ª–∏ ASR –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫)